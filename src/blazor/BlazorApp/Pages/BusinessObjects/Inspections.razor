@page "/business-objects/{businessObject}/inspections"

@inject ITranslator Translator
@inject NavigationManager NavigationManager
@inject IInspectionHandler InspectionHandler
@inject IBusinessObjectHandler BusinessObjectHandler
@inject AppAuthentication AppAuthentication

@attribute [Authorize("Inspector")]

<div class="container-fluid">
    <h1>@Translator["Inspections"]</h1>
</div>

<AuthorizeView Policy="ChiefInspector">
    <Authorized>
        <div class="container-fluid m-2">
            <button class="btn @(_mode == Mode.AssignmentMode ? "btn-primary" : "btn-outline-primary")"
                    title="@Translator["Assigment mode"]"
                    @onclick="ToggleAssignmentMode"><span class="oi oi-list"/></button>

            <button class="btn @(_mode == Mode.DropMode ? "btn-primary" : "btn-outline-primary")"
                    title="@Translator["Drop mode"]"
                    @onclick="ToggleDropMode"><span class="oi oi-media-skip-forward"/></button>

            <button class="btn @(_mode == Mode.ScheduleMode ? "btn-primary" : "btn-outline-primary")" 
                    title="@Translator["Schedule mode"]"
                    @onclick="ToggleScheduleMode"><span class="oi oi-clock"/></button>
        </div>
    </Authorized>
</AuthorizeView>

<div class="container-fluid">

@if (RelevantInspections == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-sm">
        <thead class="table-light table-borderless">
            <tr>
                <th class="col-2 d-none d-lg-table-cell">@Translator["Unique name"]</th>
                <th class="col-10">@Translator["Display name"]</th>

                <AuthorizeView Policy="ChiefInspector">
                    <Authorized>
                        <th></th>
                    </Authorized>
                </AuthorizeView>

            </tr>
        </thead>
        <tbody>
            @foreach (var inspection in RelevantInspections)
            {
                <tr>
                    <td class="d-none d-lg-table-cell">@inspection.UniqueName</td>
                    <td>
                        <BusinessObjectInspectionResponseToggle Inspection="inspection"/>
                    </td>

                    <AuthorizeView Policy="ChiefInspector">
                        <Authorized>
                            <td>
                            @if (_mode == Mode.AssignmentMode)
                            {
                                @if (_inspectionBusinessObjects!.ContainsKey(inspection.UniqueName))
                                {
                                    <button class="btn btn-primary btn-block" title="@Translator["Unassign"]"
                                            @onclick="() => UnassignAsync(inspection)"><span class="oi oi-minus"/></button>
                                }
                                else
                                {
                                    <button class="btn btn-outline-primary btn-block" title="@Translator["Assign"]"
                                            @onclick="() => AssignAsync(inspection)"><span class="oi oi-plus"/></button>
                                }
                            }

                            @if (_mode == Mode.ScheduleMode)
                            {
                                    <button class="btn btn-outline-primary btn-block" title="@Translator["Schedule"]"
                                            @onclick="() => Schedule(inspection)"><span class="oi oi-clock"/></button>
                            }

                            @if (_mode == Mode.DropMode)
                            {
                                    <button class="btn btn-outline-primary btn-block" title="@Translator["Drop"]"
                                            @onclick="() => DropAsync(inspection)"><span class="oi oi-media-skip-forward"></span></button>
                            }

                            </td>
                        </Authorized>
                    </AuthorizeView>

                </tr>
            }
        </tbody>
    </table>
}

</div>

@code {

    public enum Mode
    {
        AssignmentMode,
        ScheduleMode,
        DropMode
    }

    [Parameter]
    public string BusinessObject { get; set; } = null!;

    private IDictionary<string, BusinessObjectInspectionResponse>? _inspectionBusinessObjects;

    private IDictionary<string, BusinessObjectInspectionResponse>? _inspections;

    private Mode _mode = Mode.ScheduleMode;

    public IEnumerable<BusinessObjectInspectionResponse>? RelevantInspections
        => _mode != Mode.AssignmentMode
            ? _inspectionBusinessObjects?
                .OrderBy(x => x.Key)
                .Select(x => x.Value)

            : _inspectionBusinessObjects?
                .Concat(_inspections!
                    .Where(x => !_inspectionBusinessObjects.ContainsKey(x.Key)))
                .OrderBy(x => x.Key)
                .Select(x => x.Value);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await QueryAsync();
            StateHasChanged();
        }
    }

    public async Task QueryAsync()
    {
        _inspections = new Dictionary<string, BusinessObjectInspectionResponse>();

        if (AppAuthentication.Authorizations.Contains("ChiefInspector"))
        {
            var inspectionResponse = InspectionHandler.GetAll();

            await foreach (var inspection in inspectionResponse)
            {
                _inspections!.Add(inspection.UniqueName, new BusinessObjectInspectionResponse
                {
                    Activated = false,
                    DisplayName = inspection.DisplayName,
                    Text = inspection.Text,
                    UniqueName = inspection.UniqueName
                });
                this.StateHasChanged();
            }
        }

        var response = await BusinessObjectHandler.GetAsync(BusinessObject);

        _inspectionBusinessObjects = new Dictionary<string, BusinessObjectInspectionResponse>();

        foreach (var inspection in response.Inspections)
        {
            _inspectionBusinessObjects!.Add(inspection.UniqueName, inspection);

            this.StateHasChanged();
        }
    }

    public Task ToggleAssignmentMode()
    {
        _mode = _mode == Mode.AssignmentMode
            ? Mode.ScheduleMode
            : Mode.AssignmentMode;

        return Task.CompletedTask;
    }

    public Task ToggleScheduleMode()
    {
        _mode = Mode.ScheduleMode;

        return Task.CompletedTask;
    }

    public Task ToggleDropMode()
    {
        _mode = _mode == Mode.DropMode
            ? Mode.ScheduleMode
            : Mode.DropMode;

        return Task.CompletedTask;
    }

    public async Task AssignAsync(BusinessObjectInspectionResponse inspection)
    {
        await BusinessObjectHandler.AssignInspectionAsync(
            BusinessObject!,
            new AssignInspectionRequest
            {
                Activated = true,
                UniqueName = inspection.UniqueName
            });

        _inspectionBusinessObjects!.Add(inspection.UniqueName, _inspections![inspection.UniqueName]);
    }

    public async Task UnassignAsync(BusinessObjectInspectionResponse inspection)
    {
        await BusinessObjectHandler.CancelInspectionAsync(
            BusinessObject!,
            new CancelInspectionRequest
            {
                UniqueName = inspection.UniqueName
            });

        _inspectionBusinessObjects!.Remove(inspection.UniqueName);
    }

    public void Schedule(BusinessObjectInspectionResponse inspection)
        => NavigationManager.NavigateTo($"/business-objects/{BusinessObject}/inspections/{inspection.UniqueName}/schedule");

    public async Task DropAsync(BusinessObjectInspectionResponse inspection)
    {
        await BusinessObjectHandler.DropInspectionAuditAsync(
            BusinessObject!,
            inspection.UniqueName,
            new DropInspectionAuditRequest
            {
                PlannedAuditDate = inspection.PlannedAuditDate,
                PlannedAuditTime = inspection.PlannedAuditTime                 
            });

        var response = await BusinessObjectHandler.GetAsync(BusinessObject);

        var inspectionResponse = response.Inspections
            .SingleOrDefault(x => x.UniqueName == inspection.UniqueName);

        if (inspectionResponse != null)
        {
            inspection.PlannedAuditDate = inspectionResponse.PlannedAuditDate;
            inspection.PlannedAuditTime = inspectionResponse.PlannedAuditTime;
        }
    }
}